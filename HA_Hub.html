<!doctype html>
<html lang="it">
  <head>
	<!-- python -m http.server --directory /tmp/ -->
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@900&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	<!-- NO CACHE -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />

	<!-- STYLE -->
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	
	
    <title>Domotica</title>

  </head>
  <body>
      <!---->
      <div id="parallax-image">
          <div class="row h-100">
              <div class="col-md-12 align-self-center">
                  <h1 class="text-center">Automazioni</h1>
                  <h2 class="text-center">La tua casa SMART con Home Assistant</h2>
              </div>
          </div>
      </div>
      <div class="container">
          <h3>Scegliere/Verificare l'hardware</h3>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              Per realizzare l'HUB è necessario un PC con una o due interfacce di rete LAN ed una WiFi.<br />
              Avere due interfacce di rete LAN potrebbe essere utile nel caso in cui, ad esempio, si decidesse<br />
              di installare videocamere di sorveglianza via cavo ( utilizzando uno switch se necessario ).<br />
              Di seguito verrà descritta la procedura per la creazione di un HUB con due porte LAN ed una interfaccia WiFi.<br />
              Sarà necessario verificare che la scheda di rete WiFi che intendete utilizzare supporti la modalità MASTER o AP-Mode.<br />
              Se per realizzare l'HUB avete scelto di utilizzare un PC Intel NUC verificate che la scheda di rete supporti la modalità<br />
              Master o AP-Mode.<br />
              Se la modalità non è supportata dalla vostra scheda dovrete sostituirla o aggiungerne una.<br />
          </p>
          <a class="btn btn-outline-success" target="_blank" href="\ap_mode.html" role="Link">Guida Ubuntu WifiDocs/MasterMode</a>
          <hr style="color: black">
          <h2>Adattatori di rete testati:</h2>
          <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  Qualcomm Atheros AR9462 Wireless Network Adapter
                  <span class="badge badge-primary badge-pill">1</span>
              </li>
          </ul>
          <hr style="color: black">
      </div>
      <!---->
      <div id="parallax-image1">
          <div class="row h-100">
              <div class="col-md-12 align-self-center">
                  <h1 class="text-center">Home Assistant HUB</h1>
                  <h2 class="text-center">HUB totalmente indipendente per la casa SMART</h2>
              </div>
          </div>
      </div>
      <div class="container">
          <p>
              Il progetto consente di creare un Router, ed un Access Point con server DHCP ( che chiameremo HUB ) in grado di fornire
              indirizzi IP a tutti i dispostivi domotici ad esso connessi e gestirne la comunicazione con il server Home Assistant,
              anch'esso installato nello stesso PC.
          </p>
          <h2>Benfici</h2>
          <p>
              Il router non sarà più necessario ( tranne per le comunicazioni via Internet )<br />
              In caso di guasto la rete domotica sarà ugualmente in grado di funzionare<br />
              Si velocizza la comunicazione tra il server Home Assistant e i dispositivi, soprattuto se il router è già impegnato...<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Installazione ed avvio del Server Ubuntu</h2>
          <p>
              Installare Ubuntu Server scaricando l'immagine ISO da qui:<br />
              https://ubuntu.com/download/server
              VERSIONE PER PROCESSORI CON ARCHITETTURA AMD64 ( non ARM ) 64Bit<br />
              <a class="btn btn-outline-success" target="_blank" href="https://ubuntu.com/download/server/thank-you?version=18.04.4&architecture=amd64" role="Link">Scarica</a><br />
              Creare un supporto di avvio ( chiavetta USB ) utilizzando BALENAETCHER:<br />
              <a class="btn btn-outline-success" target="_blank" href="https://www.balena.io/etcher/" role="Link">Scarica</a><br />
              Durante l'installazione di Ubuntu abilitare il SERVER SSH.<br />
              Una volta insallato il software server e dopo aver riavviato il PC avrete a dispozione il terminale.<br />
              Accedere al sever facendo il login<br />
              Aggiornare la lista dei pacchetti:<br />
              sudo apt update<br />
              Aggiornare il software:<br />
              sudo apt upgrade<br />
              Installare i pacchetti necessari:<br />

              sudo apt install bridge-utils<br />
              sudo apt install wireless-tools<br />
              sudo apt install isc-dhcp-server<br />
              sudo apt install hostapd<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>RIMUOVERE MODEM MANAGER</h2>
          <p>
              Il servizio Modem Manager potrebbe influire negativamente con il server Home Assistant
              inoltre ne impedisce l'installazione.<br />
              Rimuovere il servizio Modem Manager:<br />
              <br />
              sudo systemctl stop ModemManager<br />
              sudo systemctl disable ModemManager<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>RIMUOVERE NETPLAN</h2>
          <p>
              Netplan è il nuovo servizio per la gestione delle interfacce di rete e sostituisce il servizio
              Network Manager.<br />
              Rimuovere il servizio Netplan:<br />
              <br />
              sudo systemctl stop ModemManager<br />
              sudo systemctl disable ModemManager<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Disabilitare la gestione delle interfacce di rete da parte di Network Manager</h2>
          <p>
              Le interfacce di rete saranno gestite manualmente...<br />
              <br />
              Verificare se il servizio Network Manager è in funzione<br />
              sudo systemctl status NetworkManager.service<br />
              <br />
              Rimuovere il servizio Network Manager<br />
              sudo systemctl stop NetworkManager.service<br />
              <br />
              Disabilitare il servizio Network Manager<br />
              sudo systemctl disable NetworkManager.service<br />
              <br />
              Verificare se il pacchetto network-manager è installato:<br />
              <br />
              apt list network-manager<br />
              <br />
              Installato:<br />
              Listing... Done<br />
              network-manager/bionic-updates 1.10.6-2ubuntu1.4 amd64    [installed]<br />
              N: There are 2 additional versions. Please use the '-a' switch to see them.<br />
              <br />
              Non installato:<br />
              Listing... Done<br />
              network-manager/bionic-updates 1.10.6-2ubuntu1.4 amd64<br />
              N: There are 2 additional versions. Please use the '-a' switch to see them.<br />
              <br />
              Rimuovere il pacchetto Network Manager e i relativi file di configurazione:<br />
              <br />
              sudo apt purge network-manager
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Configurare le interfacce di rete</h2>
          <p>
              Manuale Ubuntu:<br />
              http://manpages.ubuntu.com/manpages/bionic/man5/interfaces.5.html<br />
          </p>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              sudo nano /etc/network/interfaces<br />
              <br />
              # ifupdown has been replaced by netplan(5) on this system.<br />
              # See /etc/netplan for current configuration.<br />
              # To re-enable ifupdown on this system, you can run:<br />
              # sudo apt install ifupdown<br />
              <br />
              # The loopback network interface<br />
              auto lo<br />
              iface lo inet loopback<br />
              <br />
              # L'interfaccia enp1s0 viene utilizzata per connettere l'HUB a internet attraverso il modem-router:<br />
              <br />
              allow-hotplug enp1s0<br />
              iface enp1s0 inet static<br />
              address 192.168.1.2 # Assegnare un IP statico all'interfaccia che dipende dalla vostra rete<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />
              network 192.168.1.0
              # broadcast 192.168.1.255 # Modificare utilizzando come riferimento l'IP del vostro modem-router ( gateway ) ovvero 192.168.1.1 potrebbe essere 192.168.0.1. Deve essere 255 finale !<br />
              gateway 192.168.1.1 # Usare l'indirizzo IP del vostro modem-router ( gateway )<br />
              # Only relevant if you make use of RESOLVCONF(8) or similar...<br />
              dns-nameservers 8.8.8.8 8.8.4.4 # Specificare i server DNS ( google o altri )<br />
              <br />
              # Definizione dell'interfaccia di rete lan enp2s0 ( opzionale ). L'interfaccia può essere utilizzata, ad esempio per il collegamento
              # di videocamere IP. Se necessario usare uno switch:<br />
              <br />
              # Abilta l'interfaccia di rete enp2s0<br />
              allow-hotplug enp2s0<br />
              iface enp2s0 inet static<br />
              address 192.168.2.2<br />
              netmask 255.255.255.0<br />
              network 192.168.2.0<br />
              # broadcast 192.168.2.255<br />
              # gateway 192.168.2.1<br />
              # dns-nameservers 192.168.2.1<br />
              <br />
              # L'interfaccia di rete WiFi wlp3s0 servirà a realizzare l'Access Point WiFi
              <br />
              auto wlp3s0<br />
              iface wlp3s0 inet static<br />
              address 192.168.2.192<br />
              netmask 255.255.255.0<br />
              <br />
              # Definizione del BRIDGE - br0 setup with static wan IPv4 with ISP router as gateway<br />
              auto br0<br />
              iface br0 inet static<br />
              address 192.168.2.1 # Assegnare un indirizzo IP ( gateway ) alla vostra nuova rete: Es 192.168.3.1, 192.168.4.1<br />
              network 192.168.2.0 # Assegnare un indirizzo IP uguale all'indirizzo gateway ma con 0 finale<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />
              broadcast 192.168.2.255 # Assegnare un indirizzo IP uguale all'indirizzo gateway ma con 255 finale<br />
              bridge_ports enp2s0 wlp3s0 # Specificare le interfacce assegnate al bridge<br />
              bridge_stp off<br />
              bridge_fd 0<br />
              bridge_maxwait 0<br />
          </p>
          <hr style="color: black">
          <p>
              Salvate il file CTRL+O:<br />
              Confermate di voler salvare il file INVIO:<br />
              Chiudete l'editor nano CTRL+X:<br />
              <br />
              sudo hostapd /etc/hostapd/hostapd.conf<br />
              <br />
              Se tutto funziona correttamente il nuovo Access Point verrà creato e<br />
              per terminarlo, almeno tempoarenamente dovrete premere CRTL+C<br />
          </p>
      </div>

      <div class="container">
          <h2>Hostapd</h2>
          <p>
              Hostapd creera' il nuovo Access Point AP<br />
              <br />
              Modificare il file /etc/hostapd/hostapd.conf<br />
              <br />
              sudo nano /etc/hostapd/hostapd.conf<br />
              <br />
              Specificare il nome del nuovo Access Point:
              ssid=Home_Assistant<br />
              Specificare la password:<br />
              wpa_passphrase=PASSWORD<br />
          </p>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              # Wireless interface<br />
              # the interface used by the AP<br />
              interface=wlp3s0<br />
              #<br />
              driver=nl80211<br />
              #<br />
              bridge=br0<br />
              # the country code ( BO = Bolivia, IT = Italy )<br />
              country_code=BO<br />
              # Wireless environment<br />
              ssid=Home_Assistant<br />
              # "g" simply means 2.4GHz band<br />
              hw_mode=g<br />
              # the channel to use<br />
              channel=10<br />
              #<br />
              logger_syslog=-1<br />
              # QoS support<br />
              wmm_enabled=1<br />
              # limit the frequencies used to those allowed in the country<br />
              # ieee80211d=1<br />
              # 802.11n<br />
              ieee80211n=1<br />
              # 802.11ac<br />
              ieee80211ac=0<br />
              <br />
              #ht_capab=[HT40+][RX-STBC1][SMPS-STATIC][SHORT-GI-20][SHORT-GI-40][DSSS_CCK-40]<br />
              # Authentication and encryption<br />
              macaddr_acl=0<br />
              # 1=wpa, 2=wep, 3=both<br />
              auth_algs=1<br />
              #<br />
              # ignore_broadcast_ssid=1<br />
              <br />
              # WPA2 only<br />
              wpa=2<br />
              wpa_passphrase=PASSWORD<br />
              # WPA-PSK WPA-EAP WPA-PSK-SHA256 WPA-EAP-SHA256<br />
              wpa_key_mgmt=WPA-PSK<br />
              wpa_pairwise=TKIP<br />
              rsn_pairwise=CCMP<br />
          </p>
          <h2>Hostapd</h2>
          <p>
              Test Hostapd:<br />
              <br />
              sudo hostapd /etc/hostapd/hostapd.conf<br />
              <br />
              Se tutto funziona correttamente il nuovo Access Point verrà creato e<br />
              per terminarlo, almeno tempoarenamente dovrete premere CRTL+C<br />
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Server DHCP - isc-dhcp-server</h2>
          <p>
              Modificare il file /etc/default/isc-dhcp-server:<br />
              sudo nano /etc/default/isc-dhcp-server
          </p>
          <p style="background-color: gainsboro">
              # Defaults for isc-dhcp-server (sourced by /etc/init.d/isc-dhcp-server)<br />
              <br />
              # Path to dhcpd's config file (default: /etc/dhcp/dhcpd.conf).<br />
              #DHCPDv4_CONF=/etc/dhcp/dhcpd.conf<br />
              #DHCPDv6_CONF=/etc/dhcp/dhcpd6.conf<br />
              <br />
              # Path to dhcpd's PID file (default: /var/run/dhcpd.pid).<br />
              #DHCPDv4_PID=/var/run/dhcpd.pid<br />
              #DHCPDv6_PID=/var/run/dhcpd6.pid<br />
              <br />
              # Additional options to start dhcpd with.<br />
              #       Don't use options -cf or -pf here; use DHCPD_CONF/ DHCPD_PID instead<br />
              #OPTIONS=""<br />

              # On what interfaces should the DHCP server (dhcpd) serve DHCP requests?<br />
              #       Separate multiple interfaces with spaces, e.g. "eth0 eth1".<br />
              INTERFACESv4="enp2s0"<br />
              INTERFACESv6=""<br />
          </p>
          <p>
              Modificare il file /etc/dhcp/dhcpd.conf:<br />
              E' possibile cancellarne completamente il contenuto e sostituirlo con la configurazione<br />
              riportata di seguito, oppure modificare solo le righe seguenti:<br />
              <br />
              sudo nano /etc/dhcp/dhcpd.conf
          </p>
          <p style="background-color: gainsboro">
              # option definitions common to all supported networks...<br />
              option domain-name "domotica.org";<br />
              option domain-name-servers 8.8.8.8, 8.8.4.4;<br />
              <br />
              # The ddns-updates-style parameter controls whether or not the server will<br />
              # attempt to do a DNS update when a lease is confirmed. We default to the<br />
              # behavior of the version 2 packages ('none', since DHCP v2 didn't<br />
              # have support for DDNS.)<br />
              ddns-update-style none;<br />

              # If this DHCP server is the official DHCP server for the local<br />
              # network, the authoritative directive should be uncommented.<br />
              authoritative;<br />

              # A slightly different configuration for an internal subnet.<br />
              subnet 192.168.2.0 netmask 255.255.255.0 {<br />
                  range 192.168.2.2 192.168.2.250;<br />
                  option domain-name-servers 8.8.8.8;<br />
                  option domain-name "domotica.org";<br />
                  option subnet-mask 255.255.255.0;<br />
                  option routers 192.168.2.1;<br />
                  option broadcast-address 192.168.2.255;<br />
                  # option domain-name-servers 192.168.1.1;<br />
                  # option ntp-servers 10.152.187.1;<br />
                  option netbios-name-servers 192.168.2.1;<br />
                  option netbios-node-type 2;<br />
                  default-lease-time -1;<br />
                  max-lease-time -1;<br />

                  # Assegnare un indirizzo IP statico ai disposiviti utilizzando il MAC Address.<br />
                  # Nella nostra rete abbiamo a disposizione gli # indirizzi IP da 192.168.2.2 a 192.168.2.254<br />

                  # Assegnare un IP statico alla lampada Yeelight cucina<br />
                  host Yeelight_ceiling_cucina {<br />
                  hardware ethernet 00:00:00:00:00:00;<br />
                  fixed-address 192.168.2.130;<br />
                  }<br />

                  # Assegnare un IP statico alla lampada Yeelight camera<br />
                  host Yeelight_ceiling_camera {<br />
                  hardware ethernet 00:00:00:00:00:00;<br />
                  fixed-address 192.168.2.131;<br />
              }<br />
          </p>
          <hr style="color: black">
      </div>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>