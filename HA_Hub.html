<!doctype html>
<html lang="it">
  <head>
	<!-- python -m http.server --directory /tmp/ -->
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<link href="https://fonts.googleapis.com/css2?family=Lato:wght@900&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
	
	<!-- NO CACHE -->
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
	<meta http-equiv="Pragma" content="no-cache" />
	<meta http-equiv="Expires" content="0" />

	<!-- STYLE -->
	<link rel="stylesheet" type="text/css" href="/css/style.css">
	
	
    <title>Domotica</title>

  </head>
  <body>
      <!---->
      <div id="parallax-image">
          <div class="row h-100">
              <div class="col-md-12 align-self-center">
                  <h1 class="text-center">Home Assistant HUB</h1>
                  <h2 class="text-center">Router/AP</h2>
                  <h2 class="text-center">Aggiornato: 04/04/2020</h2>
              </div>
          </div>
      </div>
      <div class="container">
          <h3>Scegliere/Verificare l'hardware</h3>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              Per realizzare l'HUB è necessario un PC con una o due interfacce di rete LAN ed una WiFi.<br />
              Avere due interfacce di rete LAN potrebbe essere utile nel caso in cui, ad esempio, si decidesse<br />
              di installare videocamere di sorveglianza via cavo ( utilizzando uno switch se necessario ).<br />
              Di seguito verrà descritta la procedura per la creazione di un HUB con due porte LAN ed una interfaccia WiFi.<br />
              Sarà necessario verificare che la scheda di rete WiFi che intendete utilizzare supporti la modalità MASTER o AP-Mode.<br />
              Se per realizzare l'HUB avete scelto di utilizzare un PC Intel NUC verificate che la scheda di rete supporti la modalità<br />
              Master o AP-Mode.<br />
              Se la modalità non è supportata dalla vostra scheda dovrete sostituirla o aggiungerne una.<br />
          </p>
          <a class="btn btn-outline-success" target="_blank" href="\ap_mode.html" role="Link">Guida Ubuntu WifiDocs/MasterMode</a>
          <hr style="color: black">
          <h2>Adattatori di rete testati:</h2>
          <ul class="list-group">
              <li class="list-group-item d-flex justify-content-between align-items-center">
                  Qualcomm Atheros AR9462 Wireless Network Adapter
                  <span class="badge badge-primary badge-pill">1</span>
              </li>
          </ul>
          <hr style="color: black">
      </div>
      <!---->
      <div id="parallax-image1">
          <div class="row h-100">
              <div class="col-md-12 align-self-center">
                  <h1 class="text-center">Home Assistant HUB</h1>
                  <h2 class="text-center">HUB totalmente indipendente per la casa SMART</h2>
              </div>
          </div>
      </div>
      <div class="container">
          <p>
              Il progetto consente di creare un Router, ed un Access Point con server DHCP ( che chiameremo HUB ) in grado di fornire
              indirizzi IP a tutti i dispostivi domotici ad esso connessi e gestirne la comunicazione con il server Home Assistant,
              anch'esso installato nello stesso PC.
          </p>
          <h2>Benefici</h2>
          <p>
              Il router non sarà più necessario ( tranne per le comunicazioni via Internet )<br />
              In caso di guasto la rete domotica sarà ugualmente in grado di funzionare<br />
              Si velocizza la comunicazione tra il server Home Assistant e i dispositivi, soprattuto se il router è già impegnato...<br />
          </p>
          <hr style="color: black">
          <h2>Pinaificare le reti</h2>
          <p>
              Scegliere la sottorete ( quindi gli IP disponibili ) da utilizzare per l'HUB:<br />
              https://it.wikipedia.org/wiki/Sottorete<br />
              https://it.wikipedia.org/wiki/Subnet_mask<br />
              https://it.wikipedia.org/wiki/Classi_di_indirizzi_IP<br />
              https://it.wikipedia.org/wiki/Indirizzo_IP_privato<br />
              https://en.wikipedia.org/wiki/Subnetwork<br />
          </p>
          <hr style="color: black">
          <h2>Indirizzi di rete IP - Collegamento alla LAN esistente</h2>
          <p>
              In questo caso l'HUB verra collegato attraverso una porta di rete LAN ( LAN 1 interfaccia enp1s0 ) ad un Modem Router<br />
              ( Gateway ) con indirizzo IP 192.168.1.1 . All'interfaccia enp1s0 verrà assegnato un indirizzo ip facente parte della stessa<br />
              sottorete ovvero 192.168.1.2. Tutti i valori utilizzati per impostare i parametri di configurazione dell'interfaccia enp1s0,<br />
              sono basati sull'indirizzo IP del router ( ovvera la sottorete LAN attualmente in uso ).
              <br />
              La connessione SSH è disponibile all'indirizzo 192.168.1.2
          </p>
          <hr style="color: black">
          <h2>Indirizzi di rete IP - Nuova rete LAN/WiFi</h2>
          <p>
              In questo caso sarà possibile collegarsi alla porta LAN ( LAN 2 interfaccia enp2s0 ) alla quale è stato assegnato l'indirizzo
              IP STATICO 192.168.2.2 ed accedere all'HUB utilizzando lo stesso indirizzo.
              <br />
              La connessione SSH è disponibile all'indirizzo 192.168.2.2<br />
              <br />
              E all'AP rete WiFi ( interfaccia wlp3s0 )alla quale è stato assegnato l'indirizzo IP STATICO 192.168.2.192<br />
              ed accedere all'HUB utilizzando lo stesso indirizzo.<br />
              <br />
              La connessione SSH è disponibile all'indirizzo 192.168.2.192<br />
              <br />
              NB: All'interfaccia dell'AP wlp3s0 è stato assegnato l'indirizzo ip 192.168.2.192 solo per esigenze dell'autore.<br />
              L'indirzzo poteva essere, ad esempio 192.168.2.3.<br />
              <br />
              L'indirizzo IP 192.168.2.1 è assegnato al Bridge e non è possibile assegnarlo a nessuna altra interfaccia.<br />
              Al bridge dovrà sempre essere assegnato il "primo indirizzo" IP ovvero 192.168.2.1 o 192.168.3.1 o 192.168.4.1<br />
              ecc.<br />
              Per scegliere i valori network, broadcast e stabilire il range di IP assegnabili dal server DHCP è possibile utilizzare<br />
              il tool qui sotto:
          </p>
          <a class="btn btn-outline-success" target="_blank" href="\netmask.html" role="Link">Calcolatore Subnet Mask</a>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Installazione ed avvio del Server Ubuntu</h2>
          <p>
              Installare Ubuntu Server scaricando l'immagine ISO da qui:<br />
              https://ubuntu.com/download/server
              VERSIONE PER PROCESSORI CON ARCHITETTURA AMD64 ( non ARM ) 64Bit<br />
              <a class="btn btn-outline-success" target="_blank" href="https://ubuntu.com/download/server/thank-you?version=18.04.4&architecture=amd64" role="Link">Scarica</a><br />
              Creare un supporto di avvio ( chiavetta USB ) utilizzando BALENAETCHER:<br />
              <a class="btn btn-outline-success" target="_blank" href="https://www.balena.io/etcher/" role="Link">Scarica</a><br />
              Durante l'installazione di Ubuntu abilitare il SERVER SSH.<br />
              Una volta insallato il software server e dopo aver riavviato il PC avrete a dispozione il terminale.<br />
              Accedere al server effettuando il login<br />
              Aggiornare la lista dei pacchetti:<br />
              sudo apt update<br />
              Aggiornare il software:<br />
              sudo apt upgrade<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Rimuovere Modem Manager e tutte le dipendenze</h2>
          <p>
              Il servizio Modem Manager potrebbe influire negativamente con il server Home Assistant<br />
              inoltre ne impedisce l'installazione.<br />
              <br />
              Verificare se il servizio ModemManager è installato:<br />
              <br />
              dpkg -l modemmanager<br />
              apt list modemmanager<br />
              <br />
              Arrestare il servizio Modem Manager:<br />
              <br />
              sudo systemctl stop ModemManager<br />
              <br />
              Disabilitare il servizio Modem Manager:<br />
              <br />
              sudo systemctl disable ModemManager<br />
              <br />
              Rimuovere il servizio Modem Manager e tutte le sue dipendenze:<br />
              <br />
              sudo apt purge --auto-remove modemmanager<br />
              <br />
              Opzionale - Verifica disintallazione:<br />
              <br />
              systemctl list-dependencies multi-user.target | grep Modem
          </p>
          <hr style="color: black">
      </div>


      <div class="container">
          <h2>Preparazione gestione interfacce di rete con ifupdown</h2>
          <p>
              Installare i pacchetti ifupdown e bridge-utils<br />
              <br />
              sudo apt install ifupdown<br />
              <br />
              sudo apt install bridge-utils<br />
          </p>
          <hr style="color: black">
          <h2>Configurare le interfacce di rete</h2>
          <p>
              Manuale Ubuntu:<br />
              http://manpages.ubuntu.com/manpages/bionic/man5/interfaces.5.html<br />
              <br />
              Modificare il file /etc/network/interfaces<br />
              <br />
              NB: Le righe che iniziano con il carattere # sono commenti e non vengono
              considerate come istruzioni dal software<br />
              <br />
              sudo nano /etc/network/interfaces<br />
              <br />
          </p>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              # ifupdown has been replaced by netplan(5) on this system.<br />
              # See /etc/netplan for current configuration.<br />
              # To re-enable ifupdown on this system, you can run:<br />
              # sudo apt install ifupdown<br />
              <br />
              # The loopback network interface<br />
              auto lo<br />
              iface lo inet loopback<br />
              <br />
              # L'interfaccia enp1s0 viene utilizzata per connettere l'HUB a internet attraverso il modem-router:<br />
              <br />
              allow-hotplug enp1s0<br />
              iface enp1s0 inet static<br />
              address 192.168.1.2 # Assegnare un IP statico all'interfaccia che dipende dalla vostra rete<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />
              network 192.168.1.0
              gateway 192.168.1.1 # Usare l'indirizzo IP del vostro modem-router ( gateway )<br />

              <br />
              # Definizione dell'interfaccia di rete lan enp2s0 ( opzionale ). L'interfaccia può essere utilizzata, ad esempio per il collegamento
              # di videocamere IP. Se necessario usare uno switch:<br />
              <br />
              # Scegliere una sottorete ed utilizzarla per configurare le interfacce, attualemente la sottorete potrebbe essere
              # 192.168.2.0, 192.168.3.0, 192.168.4.0 altrimenti sarà necessario modificare la maschera di sottorete subnet mask
              # Utilizzeremo la sottorete 192.168.2.0
              <br />
              # Abilta l'interfaccia di rete enp2s0<br />
              allow-hotplug enp2s0<br />
              iface enp2s0 inet static<br />
              address 192.168.2.2 #  Assegnare un indirizzo statico IP all'interfaccia vedi Scegliere una sottorete<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />
              network 192.168.2.0 # Moficare utilizzando come riferimento l'IP assegnato all'interfaccia con 0 finale<br />

              <br />
              # L'interfaccia di rete WiFi wlp3s0 servirà a realizzare l'Access Point WiFi
              <br />
              auto wlp3s0<br />
              iface wlp3s0 inet static<br />
              address 192.168.2.192 # Assegnare un indirizzo statico IP all'interfaccia vedi Scegliere una sottorete<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />
              network 192.168.2.0 # Moficare utilizzando come riferimento l'IP assegnato all'interfaccia con 0 finale<br />

              <br />
              # Definizione del BRIDGE - br0 setup with static wan IPv4 with ISP router as gateway<br />
              auto br0<br />
              iface br0 inet static<br />
              address 192.168.2.1 # Assegnare un indirizzo statico IP all'interfaccia vedi Scegliere una sottorete<br />
              netmask 255.255.255.0 # Lasciare invariata la maschera di sottorete ( Subnet Mask )<br />

              network 192.168.2.0 # Moficare utilizzando come riferimento l'IP assegnato all'interfaccia con 0 finale<br />
              broadcast 192.168.2.255 # Moficare utilizzando come riferimento l'IP assegnato all'interfaccia con 255 finale<br />
              bridge_ports enp2s0 wlp3s0 # Specificare le interfacce assegnate al bridge<br />
              bridge_stp off<br />
              bridge_fd 0<br />
              bridge_maxwait 0<br />
          </p>
          <hr style="color: black">
          <p>
              Salvate il file CTRL+O:<br />
              Confermate di voler salvare il file INVIO:<br />
              Chiudete l'editor nano CTRL+X:<br />
          </p>
          <p>
              Riavvio del servizio networking;<br />
              <br />
              sudo /etc/init.d/networking restart
              <br />
          </p>
          <hr style="color: black">
      </div>


      <div class="container">
          <h2>Rimuovere Netplan</h2>
          <p>
              Netplan è il nuovo servizio per la gestione delle interfacce di rete e sostituisce il servizio
              Network Manager.<br />
              <br />
              Arrestare il servizio Netplan:<br />
              <br />
              Rimuovere il servizio Netplan:<br />
              <br />
              sudo apt purge --auto-remove netplan.io<br />
              <br />
              sudo systemctl stop systemd-networkd.socket systemd-networkd networkd-dispatcher systemd-networkd-wait-online<br />
              <br />
              sudo systemctl disable systemd-networkd.socket systemd-networkd networkd-dispatcher systemd-networkd-wait-online<br />
              <br />
              sudo systemctl mask systemd-networkd.socket systemd-networkd networkd-dispatcher systemd-networkd-wait-online<br />
              <br />
              sudo apt --assume-yes purge nplan netplan.io<br />
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Disabilitare e rimuovere Network Manager ( se presente )</h2>
          <p>
              Le interfacce di rete saranno gestite manualmente...<br />
              <br />
              Verificare se il servizio Network Manager è in funzione<br />
              <br />
              sudo systemctl status NetworkManager.service<br />
              <br />
              Arrestare il servizio Network Manager<br />
              <br />
              sudo systemctl stop NetworkManager.service<br />
              <br />
              Disabilitare il servizio Network Manager<br />
              <br />
              sudo systemctl disable NetworkManager.service<br />
              <br />
              UTILITA': Verificare se il pacchetto network-manager è installato:<br />
              <br />
              apt list network-manager<br />
              <br />
              Installato:<br />
              Listing... Done<br />
              network-manager/bionic-updates 1.10.6-2ubuntu1.4 amd64    [installed]<br />
              N: There are 2 additional versions. Please use the '-a' switch to see them.<br />
              <br />
              Non installato:<br />
              Listing... Done<br />
              network-manager/bionic-updates 1.10.6-2ubuntu1.4 amd64<br />
              N: There are 2 additional versions. Please use the '-a' switch to see them.<br />
              <br />
              Rimuovere il pacchetto Network Manager e i relativi file di configurazione:<br />
              <br />
              sudo apt purge network-manager
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Risoluzione dei nomi di domnio ( </h2>
          <p>
              Cambiare temporaneamente il server dns di default:
              <br />
              sudo nano /etc/resolv.conf
              <br />
              Impostare il valore nameserver come segue:<br />
              <br />
              nameserver 8.8.8.8
          </p>
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <p>
              Test risoluzione dei nomi:
              <br />
              nslookup www.google.com<br />
              <br />
              Installare il pacchetto resolvconf:<br />
              <br />
              sudo apt install resolvconf
              <br />
              Aggiungere alla coda della lista dei sever DNS l'indirizzo del nuovo server:<br />
              <br />
              sudo nano /etc/resolvconf/resolv.conf.d/tail<br />
              <br />
              Aggiungere:<br />
              <br />
              nameserver 8.8.8.8<br />
          </p>
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <p>
              Abilitare il nuovo server:
              <br />
              sudo resolvconf -u<br />
          </p>
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Abilitare IP FORWARDING - IPV4</h2>
          <p>
              Modificare il file sudo nano /etc/sysctl.conf:<br />
              <br />
              NB: Le righe che iniziano con il carattere # sono commenti e non vengono
              considerate come istruzioni dal software<br />
              <br />
              sudo nano sudo nano /etc/sysctl.conf
              <br />
              Elimiare il carattere # commento alla riga come mostrato di seguito e verificare che il valore<br />
              dopo il simbolo = sia 1<br />
          </p>
          <p style="background-color: gainsboro">
              net.ipv4.ip_forward=1
          </p>
          <hr style="color: black">
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
              <br />
          </p>
          <h2>Test IP FORWARDING</h2>
          <p>
              Per verificare che l'IP FORWADING sia abilitato sarà necessario riavviare il PC:<br />
              <br />
              sudo reboot<br />
              <br />
              sysctl net.ipv4.ip_forward<br />
              <br />
              La risposta dovrà essere:<br />
              <br />
              net.ipv4.ip_forward = 1
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Hostapd</h2>
          <p>
              Hostapd creera' il nuovo Access Point AP<br />
              https://help.ubuntu.com/community/WifiDocs/WirelessAccessPoint<br />
              Installare i pacchetti:<br />
              <br />
              sudo apt install wireless-tools<br />
              <br />
              sudo apt install hostapd<br />
              <br />
              Modificare il file /etc/hostapd/hostapd.conf<br />
              <br />
              NB: Le righe che iniziano con il carattere # sono commenti e non vengono
              considerate come istruzioni dal software<br />
              <br />
              sudo nano /etc/hostapd/hostapd.conf<br />
              <br />
              Specificare il nome del nuovo Access Point:<br />
              ssid=Home_Assistant, o vostra scelta<br />
              Specificare la password:<br />
              wpa_passphrase=PASSWORD<br />
              <br />
              La potenza del segnale radio ed i canali disponibili sono gestiti dalle<br />
              diverse nazioni. Impostate la vostra nazione utilizzando i codici Country code (ISO/IEC 3166-1)<br />
              riportati in questa lista:<br />
              https://en.wikipedia.org/wiki/List_of_ISO_3166_country_codes
              <br />
              country_code=IT
          </p>
          <!-- CODE -->
          <p style="background-color: gainsboro">
              interface=wlp3s0<br />
              driver=nl80211<br />
              bridge=br0<br />
              # Codice della nazione ( BO = Bolivia, IT = Italy, US = United States of America )<br />
              country_code=BO<br />
              # Nome del nuovo Access Point
              ssid=Home_Assistant<br />
              # "g" Modalità rete g frequenza 2.4GHz<br />
              hw_mode=g<br />
              # Specificare il canale<br />
              channel=10<br />
              #<br />
              logger_syslog=-1<br />
              # Supporto QoS<br />
              wmm_enabled=1<br />
              <br />
              # Autenticazione e crittografia<br />
              macaddr_acl=0<br />
              # Algoritmo di autenticazione 1=wpa, 2=wep, 3=both<br />
              auth_algs=1<br />
              # WPA2 Wi-Fi Protected Access II (WPA2)<br />
              wpa=2<br />
              # Specificare la password per accedere all'AP
              wpa_passphrase=PASSWORD<br />
              # WPA-PSK WPA-EAP WPA-PSK-SHA256 WPA-EAP-SHA256<br />
              wpa_key_mgmt=WPA-PSK<br />
              wpa_pairwise=TKIP<br />
              rsn_pairwise=CCMP<br />
          </p>
          <hr style="color: black">
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <h2>Test Hostapd</h2>
          <p>
              A questo punto potrebbe essera utile eseguire un test di Hostapd:<br />
              https://manpages.debian.org/testing/hostapd/hostapd.8.en.html<br />
              <br />
              sudo hostapd /etc/hostapd/hostapd.conf<br />
              <br />
              sudo hostapd -d /etc/hostapd/hostapd.conf<br />
              <br />
              Se tutto funziona correttamente il nuovo Access Point verrà creato, verificate
              che esista la nuova rete WiFi. Se tenterete di connettervi alla nuova rete vedrete
              apparire, sullo schermo, alcune inforamzioni ma non vi sarà possibile connettervi alla nuova rete
              per ora.<br />
              Terminate Hostapd premendo CRTL+C<br />
          </p>
          <hr style="color: black">
          <h2>Abilitare definitivamente Hostapd</h2>
          <p>
              Per fare in modo che l'Access Point venga creato automaticamente all'avvio dell'HUB<br />
              midificare il file /etc/default/hostapd:<br />
              <br />
              sudo nano /etc/default/hostapd<br />
              <br />
              Trovare la riga DAEMON_CONF. Se è presente il simbolo di commento # all'inizio<br />
              della riga rimuoverlo e modificare il valore impostandolo come segue:<br />
              <br />
              DAEMON_CONF="/etc/hostapd/hostapd.conf"<br />
          </p>
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <p>
              Abilitare hostapd ad essere utilizzato come sevizio:<br />
              <br />
              sudo systemctl unmask hostapd<br />
              <br />
              Abilitare il servizio hostapd:<br />
              <br />
              sudo systemctl enable hostapd<br />
              <br />
              Avviare il servizio hostapd:<br />
              <br />
              sudo systemctl start hostapd<br />
              <br />
              Verificare che il servizio hostapd sia in funzione:<br />
              <br />
              sudo systemctl status hostapd<br />
              <br />
              Da questo momento in poi il nuovo AP verrà creato automaticamente all'avvio dell'HUB.
          </p>
          <hr style="color: black">
      </div>

      <div class="container">
          <h2>Server DHCP - isc-dhcp-server</h2>
          <p>
              Installare il server DHCP isc-dhcp-server:<br />
              <br />
              sudo apt install isc-dhcp-server
              <br />
              Modificare il file /etc/default/isc-dhcp-server:<br />
              <br />
              NB: Le righe che iniziano con il carattere # sono commenti e non vengono
              considerate come istruzioni dal software<br />
              <br />
              sudo nano /etc/default/isc-dhcp-server
          </p>
          <p style="background-color: gainsboro">
              # Defaults for isc-dhcp-server (sourced by /etc/init.d/isc-dhcp-server)<br />
              <br />
              # Path to dhcpd's config file (default: /etc/dhcp/dhcpd.conf).<br />
              #DHCPDv4_CONF=/etc/dhcp/dhcpd.conf<br />
              #DHCPDv6_CONF=/etc/dhcp/dhcpd6.conf<br />
              <br />
              # Path to dhcpd's PID file (default: /var/run/dhcpd.pid).<br />
              #DHCPDv4_PID=/var/run/dhcpd.pid<br />
              #DHCPDv6_PID=/var/run/dhcpd6.pid<br />
              <br />
              # Additional options to start dhcpd with.<br />
              #       Don't use options -cf or -pf here; use DHCPD_CONF/ DHCPD_PID instead<br />
              #OPTIONS=""<br />

              # On what interfaces should the DHCP server (dhcpd) serve DHCP requests?<br />
              #       Separate multiple interfaces with spaces, e.g. "eth0 eth1".<br />
              INTERFACESv4="br0"<br />
              INTERFACESv6=""<br />
          </p>
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <p>
              Modificare il file /etc/dhcp/dhcpd.conf:<br />
              <br />
              NB: Le righe che iniziano con il carattere # sono commenti e non vengono
              considerate come istruzioni dal software<br />
              <br />
              E' possibile cancellarne completamente il contenuto e sostituirlo con la configurazione<br />
              riportata di seguito, oppure modificare solo le righe seguenti:<br />
              <br />
              sudo nano /etc/dhcp/dhcpd.conf
          </p>
          <p style="background-color: gainsboro">
              # option definitions common to all supported networks...<br />
              option domain-name "domotica.org";<br />
              option domain-name-servers 8.8.8.8, 8.8.4.4;<br />
              <br />
              # The ddns-updates-style parameter controls whether or not the server will<br />
              # attempt to do a DNS update when a lease is confirmed. We default to the<br />
              # behavior of the version 2 packages ('none', since DHCP v2 didn't<br />
              # have support for DDNS.)<br />
              ddns-update-style none;<br />

              # If this DHCP server is the official DHCP server for the local<br />
              # network, the authoritative directive should be uncommented.<br />
              authoritative;<br />

              # Utilizzare come riferimento quanto specificato nella definizione delle interfacce di rete. Il server DHCP
              # rispondera alle richieste nella sottorete definita in precedenza e sarà in grado di assegnare un determinato
              # range di IP solo in questa sottorete.
              # SPECIFICATO IN CONFIGURARE LE INTERFACCE DI RETE
              # Scegliere una sottorete ed utilizzarla per configurare le interfacce, attualemente la sottorete potrebbe essere
              # 192.168.2.0, 192.168.3.0, 192.168.4.0 altrimenti sarà necessario modificare la maschera di sottorete subnet mask
              # Utilizzeremo la sottorete 192.168.2.0

              # subnet utilizzare la sottorete 192.168.2.0
              # range il range di IP che verrà assegnato ai dispositivi da 192.168.2.2 a 192.168.2.250

              # A slightly different configuration for an internal subnet.<br />
              subnet 192.168.2.0 netmask 255.255.255.0 {<br />
              range 192.168.2.2 192.168.2.250; # Il range di IP che verrà assegnato ai dispositivi da 192.168.2.2 a 192.168.2.250<br />
              option domain-name-servers 8.8.8.8; # L'indirizzo del server DNS ( google in questo caso )<br />
              option domain-name "domotica.org" # Il nome del dominio;<br />
              option subnet-mask 255.255.255.0;<br />
              option routers 192.168.2.1; # Utilizzare l'indirizzo assegnato alla subnet ma con 1 finale<br />
              option broadcast-address 192.168.2.255; # Utilizzare l'indirizzo assegnato alla subnet ma con 255 finale<br />
              # option domain-name-servers 192.168.1.1;<br />
              # option ntp-servers 10.152.187.1;<br />
              option netbios-name-servers 192.168.2.1 # Utilizzare l'indirizzo assegnato alla subnet ma con 255 finale;<br />
              option netbios-node-type 2;<br />
              default-lease-time -1; # Nessun tempo di lease l'indirizzo IP assegnato non ha un tempo di scadenza<br />
              max-lease-time -1; # Nessun tempo di lease l'indirizzo IP assegnato non ha un tempo di scadenza<br />

              # Assegnare un indirizzo IP statico ai disposiviti utilizzando il MAC Address.<br />
              # Nella nostra rete abbiamo a disposizione gli # indirizzi IP da 192.168.2.2 a 192.168.2.254<br />

              # Assegnare un IP statico alla lampada Yeelight cucina<br />
              host Yeelight_ceiling_cucina {<br />
              hardware ethernet 00:00:00:00:00:00;<br />
              fixed-address 192.168.2.130;<br />
              }<br />

              # Assegnare un IP statico alla lampada Yeelight camera<br />
              host Yeelight_ceiling_camera {<br />
              hardware ethernet 00:00:00:00:00:00;<br />
              fixed-address 192.168.2.131;<br />
              }<br />
          </p>
          <hr style="color: black">
          <p>
              Salvare il file CTRL+O:<br />
              Confermare di voler salvare il file INVIO:<br />
              Chiudere l'editor nano CTRL+X:<br />
          </p>
          <h2>Test server DHCP</h2>
          <p>
              Avviare il server DHCP:<br />
              <br />
              sudo systemctl start isc-dhcp-server<br />
              <br />
              Se non viene visualizzato nessun messaggio di errore è possibile installare il servizio<br />
              DHCP server, questo fa si che al prossimo avvio del PC il server venga avviato automaticamente:<br />
              <br />
              sudo systemctl enable isc-dhcp-server<br />
              <br />
              Controllare lo stato del server:<br />
              <br />
              sudo systemctl status isc-dhcp-server<br />
              <br />
              Vedere il log degli errori:<br />
              <br />
              journalctl -xe<br />
              <br />
              Riavviare il server se vengono apportate modifiche al file di configurazione:<br />
              sudo systemctl restart isc-dhcp-server<br />
              <br />
              Se tutto è andato bene il server DHCP è in funzione ed assegenera un nuovo IP ad<br />
              ogni dispositivo che si collegherà all'HUB, a meno che, non sia impostato un IP<br />
              statico nel dispositivo.<br />
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>PRIMO TEST FUNZIONALITA' RETE</h2>
          <p>
              Riavviate l'HUB<br />
              <br />
              sudo reboot<br />
              <br />
              Verificare che il servizio Hostapd sia in funzione:<br />
              <br />
              sudo systemctl status hostapd.service<br />
              <br />
              Se il servizio è attivo l'output sarà simile a:<br />
              <br />
              ● hostapd.service - Advanced IEEE 802.11 AP and IEEE 802.1X/WPA/WPA2/EAP Authenticator<br />
              Loaded: loaded (/lib/systemd/system/hostapd.service; enabled; vendor preset: enabled)<br />
              Active: active (running) since Thu 2020-04-02 07:37:07 UTC; 5h 23min ago<br />
              Process: 1287 ExecStart=/usr/sbin/hostapd -P /run/hostapd.pid -B $DAEMON_OPTS ${DAEMON_CONF} (code=exited, status=0/SUCCESS)<br />
              Main PID: 1375 (hostapd)<br />
              Tasks: 1 (limit: 4915)<br />
              CGroup: /system.slice/hostapd.service<br />
              └─1375 /usr/sbin/hostapd -P /run/hostapd.pid -B /etc/hostapd/hostapd.conf<br />
              <br />
              Premete CTRL+C per uscire dal log di stato.<br />
              <br />
              Verificare che il servizio isc-dhcp-server ( server DHCP ) sia in funzione:<br />
              <br />
              sudo systemctl status isc-dhcp-server<br />
              <br />
              Se il servizio è attivo l'output sarà simile a:<br />
              ● isc-dhcp-server.service - ISC DHCP IPv4 server<br />
              Loaded: loaded (/lib/systemd/system/isc-dhcp-server.service; enabled; vendor preset: enabled)<br />
              Active: active (running) since Thu 2020-04-02 07:37:07 UTC; 5h 28min ago<br />
              Docs: man:dhcpd(8)<br />
              Main PID: 1266 (dhcpd)<br />
              Tasks: 1 (limit: 4915)<br />
              CGroup: /system.slice/isc-dhcp-server.service<br />
              └─1266 dhcpd -user dhcpd -group dhcpd -f -4 -pf /run/dhcp-server/dhcpd.pid -cf /etc/dhcp/dhcpd.conf<br />
              <br />
              Premete CTRL+C per uscire dal log di stato.<br />
              <br />
              Se entrambe i servizi sono attivi sarà proseguire, altrimenti sarà necessario rivedere i file di configurazione<br />
              controllare i log, riavviare i servizi fino a quando essi non saranno eseguiti senza errori.
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>ROUTING STATICO</h2>
          <p>
              I pacchetti destinati alla rete WAN ( internet ) non possono ancora essere instradati<br />
              verso di essa.<br />
              Per poter essere instradati sarà necessario specificare una nuova ROUTE con NAT.<br />
          </p>
          <p style="background-color: gainsboro">
              sudo iptables -t nat -A POSTROUTING -o enp1s0 -j MASQUERADE
          </p>
          <hr style="color: black">
          <p>
              Ora collegandosi all'HUB ( Access Point dell'HUB ) sarà possibile accedere ad Internet.
          </p>
          <h2>IP TABLES</h2>
          <p>
              Installare il pacchetto iptables-persistent<br />
              <br />
              sudo apt install iptables-persistent<br />
              <br />
              La nuova route però deve essere salvata altrimenti ad ogni riavvio dovrà essere reinserita:<br />
              <br />
              sudo netfilter-persistent save<br />
              <br />
              Vedere le regole iptables in uso:<br />
              <br />
              sudo iptables -S
              <br />
              e/o<br />
              <br />
              sudo iptables -L
          </p>
          <hr style="color: black">
      </div>
      <div class="container">
          <h2>Test del route</h2>
          <p style="font-size=14px">
              Prima di installare Docker-ce e Home Assistant testate il solo router.<br/>
              Collegandovi al nuovo Access Point sarà possibile navigare normalmente.
          </p>
          <hr style="color: black">
      </div>
      <!-- Optional JavaScript -->
      <!-- jQuery first, then Popper.js, then Bootstrap JS -->
      <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
      <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
  </body>
</html>